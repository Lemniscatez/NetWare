using NetWare.Helpers;
using Photon.Pun;
using UnityEngine;
using UnityEngine.UI;

namespace NetWare
{
    public class Exploits : MonoBehaviour
    {
        public static void Execute()
        {
            // player
            if (!Config.GetBool("exploits.gameplay.autoplay"))
            {
                LocalPlayer.GetHealth()?.SetPlayerImmunity(Config.GetBool("exploits.player.godmode"));
            }

            if (Config.GetBool("exploits.player.instantland"))
            {
                LocalPlayer.GetThirdPersonController()?.SetDiveState(false);
            }

            if (Config.GetBool("exploits.player.infinitematerials"))
            {
                Access.SetValue(
                    LocalPlayer.GetPlayerBuildingManager()?.buildingManager,
                    "OLDOMPKABCM",
                    1000
                );
            }

            if (Config.GetBool("exploits.player.antifreeze"))
            {
                LocalPlayer.Get()?.photonView?.gameObject?.SetActive(true);
            }

            // gameplay
            if (Config.GetBool("exploits.gameplay.autoplay"))
            {
                // update timer
                ExploitsH.autoPlayTimer++;

                // check for overtime
                string timerText = ((Text)Access.GetValue(
                    TimerCounter.LIPLNDMKLDB,
                    "_timerText")
                )?.text;

                if (timerText == "OVERTIME")
                {
                    ResultScreenManager.LIPLNDMKLDB.OnPlayAgainPressed();
                }

                // godmode
                LocalPlayer.GetHealth()?.SetPlayerImmunity(true);

                if (ExploitsH.autoPlayTimer >= 2)
                {
                    // play again
                    FindObjectOfType<MatchResultScreen>()?.PlayAgainPressed();

                    if (ExploitsH.autoPlayTimer >= 6)
                    {
                        // kill everyone
                        Network.BecomeMasterClient();
                        
                        foreach (PlayerController playerController in Storage.players)
                        {
                            if (Players.IsPlayerValid(playerController) && !Players.IsPlayerTeammate(playerController))
                            {
                                playerController?.photonView?.RPC(
                                    "TakeHit",
                                    RpcTarget.All,
                                    new object[] {
                                        100000,
                                        playerController?.transform.position,
                                        playerController?.photonView?.CreatorActorNr,
                                        true
                                    }
                                );
                            }
                        }
                    }
                }

                // reset timer
                if (ExploitsH.autoPlayTimer >= 10)
                {
                    ExploitsH.autoPlayTimer = 0;
                }
            }

            // game
            if (Config.GetBool("exploits.game.buildingspam") && Storage.players.Length > 0)
            {
                ExploitsH.buildingSpammerTimer++;

                if (ExploitsH.buildingSpammerTimer > 6)
                {
                    Network.BecomeMasterClient();

                    PlayerController playerController = Storage.players[UnityEngine.Random.Range(0, Storage.players.Length)];

                    if (Players.IsPlayerValid(playerController) && !Players.IsPlayerTeammate(playerController))
                    {
                        Vector3 buildingPosition = playerController.OBPJMLEMMCN;
                        BuildingNetworkController buildingNetworkController = Network.GetBuildingNetworkController();

                        if (buildingNetworkController != null)
                        {
                            buildingNetworkController.CreateBuilding(HABLAODDMOK.Wall, buildingPosition, Quaternion.identity);
                            buildingNetworkController.CreateBuilding(HABLAODDMOK.Floor, buildingPosition, Quaternion.identity);
                            buildingNetworkController.CreateBuilding(HABLAODDMOK.Ramp, buildingPosition, Quaternion.identity);
                            buildingNetworkController.CreateBuilding(HABLAODDMOK.Roof, buildingPosition, Quaternion.identity);
                        }
                    }

                    ExploitsH.buildingSpammerTimer = 0;
                }
            }

            if (Config.GetBool("exploits.game.rigspam"))
            {
                ExploitsH.rigSpamTimer++;

                if (ExploitsH.rigSpamTimer > 10)
                {
                    PlayerController localPlayer = LocalPlayer.Get();

                    if (localPlayer != null)
                    {
                        PhotonNetwork.Instantiate("PolyPlayer", localPlayer.gameObject.transform.position, Quaternion.identity, 0, null);
                    }

                    ExploitsH.rigSpamTimer = 0;
                }
            }

            PlayerBuildingManager.IsOneHitBuildings = Config.GetBool("exploits.game.instantbreak");

            // fun
            if (Config.GetBool("exploits.fun.levelchanger"))
            {
                ServerUser serverUser = FirebaseManager.LIPLNDMKLDB?.IPGFHABIDAC;

                if (serverUser != null)
                {
                    foreach (UserUpgradeableItem userUpgradeableItem in serverUser.Equipment.Equipment.Values)
                    {
                        userUpgradeableItem.Level = Config.GetInt("exploits.fun.levelchangeramount");
                    }
                }
            }
        }

        public static void Tab()
        {
            Menu.Begin();

            Menu.NewSection("Player");
            Config.SetBool(
                "exploits.player.godmode",
                Menu.NewToggle(
                    Config.GetBool("exploits.player.godmode"),
                    "Godmode"
                )
            );
            Config.SetBool(
                "exploits.player.instantland",
                Menu.NewToggle(
                    Config.GetBool("exploits.player.instantland"),
                    "Instant Land"
                )
            );
            Config.SetBool(
                "exploits.player.infinitematerials",
                Menu.NewToggle(
                    Config.GetBool("exploits.player.infinitematerials"),
                    "Infinite Materials"
                )
            );
            Config.SetBool(
                "exploits.player.antifreeze",
                Menu.NewToggle(
                    Config.GetBool("exploits.player.antifreeze"),
                    "Anti Freeze"
                )
            );

            Menu.NewSection("Gameplay");
            Menu.NewButton("Leave Game", ExploitsH.LeaveGame);
            Config.SetBool(
                "exploits.gameplay.autoplay",
                Menu.NewToggle(
                    Config.GetBool("exploits.gameplay.autoplay"),
                    "Auto Play"
                )
            );

            Menu.NewSection("Locker");
            Menu.NewButton("Unlock Emotes", ExploitsH.UnlockEmotes);
            Menu.NewButton("Unlock Stickers", ExploitsH.UnlockStickers);
            Menu.NewTitle("Skins");
            ExploitsH.changeSkinId = Menu.NewTextField("Skin ID", ExploitsH.changeSkinId);
            Menu.NewButton("Change Skin", ExploitsH.ChangeSkin);
            ExploitsH.pickaxeChangerId = Menu.NewList("Pickaxe ID", ExploitsH.pickaxeChangerId, new string[] {
                "Default",
                "Galactic Smasher",
                "Warhammer",
                "Chicken Axe",
                "Candy Cane",
                "Lethal Gift"
            });
            Menu.NewButton("Change Pickaxe", ExploitsH.ChangePickaxe);

            Menu.Separate();

            Menu.NewSection("Game");
            Menu.NewButton("Force Win", ExploitsH.ForceWin);
            Menu.NewButton("Kill All", ExploitsH.KillAll);
            Menu.NewButton("Freeze Players", ExploitsH.FreezePlayers);
            Menu.NewButton("Destroy Buildings", ExploitsH.DestroyBuildings);
            Menu.NewButton("Open Crates", ExploitsH.OpenCrates);
            Config.SetBool(
                "exploits.game.buildingspam",
                Menu.NewToggle(
                    Config.GetBool("exploits.game.buildingspam"),
                    "Building Spam"
                )
            );
            Config.SetBool(
                "exploits.game.rigspam",
                Menu.NewToggle(
                    Config.GetBool("exploits.game.rigspam"),
                    "Rig Spam"
                )
            );
            Config.SetBool(
                "exploits.game.instantbreak",
                Menu.NewToggle(
                    Config.GetBool("exploits.game.instantbreak"),
                    "Instant Break"
                )
            );

            Menu.NewSection("Fun");
            Menu.NewButton("Add 10k Fake Gold", ExploitsH.AddFakeGold);
            Menu.NewButton("Add 10k Fake Gems", ExploitsH.AddFakeGems);
            Menu.NewTitle("Loadout Level Changer");
            Config.SetBool(
                "exploits.fun.levelchanger",
                Menu.NewToggle(
                    Config.GetBool("exploits.fun.levelchanger"),
                    "Enabled"
                )
            );
            Config.SetInt(
                "exploits.fun.levelchangeramount",
                (int)Menu.NewSlider(
                    "Amount",
                    Config.GetInt("exploits.fun.levelchangeramount"),
                    1,
                    100000
                )
            );

            Menu.End();
        }
    }
}
